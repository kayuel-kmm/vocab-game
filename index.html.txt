<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‹¨ì–´ ê²Œì„ v4 (ì£¼ê°„/ëˆ„ì  + ë³´ìƒ + ë³µìŠµ + ìŒì„± + ì¡°ê° ìŠ¤í ë§)</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 0; background:#f6f7fb; }
    header { padding: 14px 12px; background: white; border-bottom: 1px solid #e7e7ee; position: sticky; top:0; z-index: 10; }
    main { max-width: 980px; margin: 0 auto; padding: 12px; display: grid; gap: 12px; }
    .card { background: white; border:1px solid #e7e7ee; border-radius: 16px; padding: 14px; box-shadow: 0 4px 14px rgba(10,10,20,.04); }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1; min-width: 140px; }
    input, select, button, textarea {
      font: inherit; padding: 12px 12px; border-radius: 12px; border: 1px solid #d9d9e6; background: white;
    }
    textarea { width:100%; min-height: 90px; }
    button { cursor:pointer; border:1px solid #cfcfe2; background:#111827; color:white; }
    button.secondary { background:white; color:#111827; }
    button.ghost { background: #eef2ff; color:#111827; border-color:#d6dcff; }
    button.danger { background:#b91c1c; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .pill { display:inline-flex; gap:8px; align-items:center; padding: 6px 10px; background:#eef2ff; border:1px solid #d6dcff; border-radius:999px; font-size: 13px; }
    .big { font-size: 34px; font-weight: 900; letter-spacing: .4px; }
    .muted { color:#6b7280; font-size: 13px; }
    .progress { height:10px; background:#eef2ff; border:1px solid #d6dcff; border-radius:999px; overflow:hidden; }
    .bar { height:100%; background:#4f46e5; width:0%; }
    .options { display:grid; gap: 10px; }
    .options button { text-align:left; background:white; color:#111827; font-size: 18px; padding: 16px 14px; }
    .options button.correct { border-color:#16a34a; background:#ecfdf3; }
    .options button.wrong { border-color:#dc2626; background:#fff1f2; }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; padding: 2px 6px; border:1px solid #e5e7eb; border-radius: 6px; background:#f9fafb; }
    .list { width:100%; border-collapse: collapse; }
    .list th, .list td { border-bottom: 1px solid #eee; padding: 8px; text-align:left; font-size: 14px; vertical-align: middle; }
    .right { text-align:right; }
    .chk { width:18px; height:18px; vertical-align: middle; }

    .gameOnly header, .gameOnly #adminCard, .gameOnly #listCard { display:none !important; }
    .gameOnly main { padding: 10px; }
    .gameOnly #gameCard { display:block !important; }

    .chunkCard { border: 1px solid #e7e7ee; border-radius: 14px; padding: 12px; background: #fff; }
  </style>
</head>

<body>
<header>
  <div class="row" style="max-width:980px;margin:0 auto;">
    <div style="flex:2;min-width:220px;">
      <div style="font-weight:900;">ë‹¨ì–´ ê²Œì„ v4</div>
      <div class="muted">ì£¼ê°„/ëˆ„ì  + ë³´ìƒ + í‹€ë¦°ë‹¨ì–´ ë³µìŠµ + ì •ë‹µ ìŒì„± + ìŠ¤í ë§(ì¡°ê° ì„ íƒ)</div>
    </div>
    <div class="row" style="justify-content:flex-end; flex:1;">
      <span class="pill" id="countPill">ë‹¨ì–´ 0ê°œ</span>
      <select id="mode">
        <option value="meaning">1ë‹¨ê³„: ëœ»</option>
        <option value="pron">2ë‹¨ê³„: ë°œìŒ(í•œê¸€)</option>
        <option value="spelling">3ë‹¨ê³„: ìŠ¤í ë§(ì¡°ê°)</option>
      </select>
      <button class="ghost" id="startBtn">ì‹œì‘</button>
    </div>
  </div>
</header>

<main>
  <section class="card" id="adminCard">
    <div class="row">
      <div style="flex:2;min-width:240px;">
        <div style="font-weight:900;">ë‹¨ì–´ ê´€ë¦¬</div>
        <div class="muted">ì²˜ìŒ ì ‘ì† ì‹œ ê¸°ë³¸ ë‹¨ì–´ê°€ ìë™ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤(í° í¬í•¨). ì´í›„ ì¶”ê°€/ìˆ˜ì •ë„ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>
      <div class="right" style="flex:1;">
        <button class="secondary" id="exportBtn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
        <button class="secondary" id="importBtn">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
        <button class="danger" id="resetBtn">ì „ì²´ ì‚­ì œ</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <input id="w_en" placeholder="ì˜ë‹¨ì–´ (ì˜ˆ: school)" autocomplete="off" />
      <input id="w_ko" placeholder="ëœ» (ì˜ˆ: í•™êµ)" autocomplete="off" />
      <input id="w_pron" placeholder="ë°œìŒ(í•œê¸€) (ì˜ˆ: ìŠ¤ì¿¨)" autocomplete="off" />
      <label class="pill" style="flex:0;min-width:auto;">
        <input type="checkbox" id="w_week" class="chk" />
        ì´ë²ˆ ì£¼
      </label>
      <button id="addBtn">ì¶”ê°€</button>
    </div>

    <details style="margin-top:12px;">
      <summary class="muted">ëŒ€ëŸ‰ ì…ë ¥(ê°„ë‹¨): ì˜ì–´ë§Œ / ë˜ëŠ” ì˜ì–´|ëœ»|ë°œìŒ|week</summary>
      <textarea id="bulk" placeholder="ì˜ˆ)
school
book
pizza

ë˜ëŠ”
school | í•™êµ | ìŠ¤ì¿¨ | week
book | ì±… | ë¶"></textarea>
      <div class="row" style="margin-top:8px;">
        <button class="secondary" id="bulkAddBtn">ëŒ€ëŸ‰ ì¶”ê°€</button>
        <span class="muted">ì˜ì–´ë§Œ ë„£ìœ¼ë©´ ëœ»/ë°œìŒì€ ë¹ˆì¹¸ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.</span>
      </div>
    </details>

    <div class="row" style="margin-top:12px;">
      <button class="secondary" id="clearWeeklyBtn">ì´ë²ˆ ì£¼ ì „ì²´ í•´ì œ</button>
      <button class="secondary" id="markAllWeeklyBtn">ì „ì²´ë¥¼ ì´ë²ˆ ì£¼ë¡œ</button>
      <span class="muted">â€» ìƒˆ ì£¼ ì‹œì‘ ì‹œ â€œì´ë²ˆ ì£¼ ì „ì²´ í•´ì œâ€ â†’ ìƒˆ 10~20ê°œë§Œ ì²´í¬</span>
    </div>
  </section>

  <section class="card" id="gameCard" style="display:none;">
    <div class="row">
      <div style="flex:2;">
        <div class="muted" id="stageLabel">ë‹¨ê³„</div>
        <div class="big" id="prompt">-</div>
        <div class="muted" id="hint"></div>

        <div class="row" style="margin-top:10px;">
          <select id="scope">
            <option value="weekly">ì¶œì œ: ì´ë²ˆ ì£¼</option>
            <option value="all">ì¶œì œ: ëˆ„ì (ì „ì²´)</option>
          </select>
          <button class="secondary" id="reviewBtn">ë³µìŠµ(í‹€ë¦° ë‹¨ì–´)</button>
          <button class="secondary" id="speakBtn">ğŸ”Š ì •ë‹µ ë°œìŒ</button>
          <label class="pill" style="gap:10px; flex:0; min-width:auto;">
            <input type="checkbox" id="autoSpeak" class="chk" />
            ì •ë‹µ ì‹œ ìë™
          </label>
          <button class="secondary" id="toggleGameOnly">ğŸ“± ê²Œì„í™”ë©´ë§Œ</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <span class="pill" id="starsPill">â­ 0</span>
          <span class="pill" id="stickersPill">ğŸ… 0</span>
          <button class="ghost" id="rewardBtn">ë³´ìƒ ë°›ê¸°</button>
          <span class="muted" id="rewardHint"></span>
        </div>

        <div class="muted" id="ttsNote" style="margin-top:6px;"></div>
      </div>

      <div style="flex:1; min-width:240px;">
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="row" style="margin-top:10px;">
          <span class="pill" id="scorePill">ì ìˆ˜ 0</span>
          <span class="pill" id="idxPill">0 / 0</span>
          <span class="pill" id="streakPill">ì—°ì† 0</span>
          <button class="secondary" id="skipBtn">ê±´ë„ˆë›°ê¸°</button>
        </div>
      </div>
    </div>

    <div style="margin-top:14px;">
      <div class="options" id="options"></div>
    </div>

    <div id="chunkArea" style="display:none; margin-top:12px;">
      <div class="muted">ì¡°ê°ì„ ìˆœì„œëŒ€ë¡œ ê³¨ë¼ ë‹¨ì–´ë¥¼ ì™„ì„±í•˜ì„¸ìš”.</div>
      <div id="chunkSlots" style="display:grid; gap:10px; margin-top:10px;"></div>
      <div class="row" style="margin-top:12px;">
        <span class="pill" id="builtWordPill">ì™„ì„±: </span>
        <button class="secondary" id="resetChunksBtn">ì²˜ìŒë¶€í„°</button>
        <button class="ghost" id="checkChunksBtn">ì •ë‹µ í™•ì¸</button>
      </div>
      <div class="muted" id="chunkFeedback" style="margin-top:8px;"></div>
    </div>

    <div class="row" style="margin-top:14px;">
      <button id="nextBtn" class="ghost" style="display:none;">ë‹¤ìŒ</button>
      <span class="muted" id="feedback"></span>
    </div>
  </section>

  <section class="card" id="listCard">
    <div class="row">
      <div style="flex:2;">
        <div style="font-weight:900;">ë‹¨ì–´ ëª©ë¡</div>
        <div class="muted">ìˆ˜ì •/ì‚­ì œ + â€œì´ë²ˆ ì£¼â€ ì²´í¬</div>
      </div>
    </div>
    <div style="overflow:auto; margin-top:10px;">
      <table class="list">
        <thead>
          <tr><th>ì´ë²ˆ ì£¼</th><th>ì˜ë‹¨ì–´</th><th>ëœ»</th><th>ë°œìŒ(í•œê¸€)</th><th class="right">ê´€ë¦¬</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
(() => {
  const LS_WORDS = "kid_vocab_v4_words";
  const LS_TTS   = "kid_vocab_v4_tts";
  const LS_META  = "kid_vocab_v4_meta";

  // âœ… ê¸°ë³¸ ë‹¨ì–´(ì²˜ìŒ ì ‘ì†í•œ ê¸°ê¸°ì—ì„œë„ ìë™ìœ¼ë¡œ ë“¤ì–´ê°€ê²Œ)
  const DEFAULT_WORDS = [
    {"en":"fun","ko":"ì¬ë¯¸ìˆëŠ”","pron":"í€","weekly":true},
    {"en":"bed","ko":"ì¹¨ëŒ€","pron":"ë² ë“œ","weekly":true},
    {"en":"book","ko":"ì±…","pron":"ë¶","weekly":true},
    {"en":"name","ko":"ì´ë¦„","pron":"ë„¤ì„","weekly":true},
    {"en":"play","ko":"ë†€ë‹¤","pron":"í”Œë ˆì´","weekly":true},
    {"en":"go","ko":"ê°€ë‹¤","pron":"ê³ ","weekly":true},

    {"en":"school","ko":"í•™êµ","pron":"ìŠ¤ì¿¨","weekly":true},
    {"en":"like","ko":"ì¢‹ì•„í•˜ë‹¤","pron":"ë¼ì´í¬","weekly":true},
    {"en":"read","ko":"ì½ë‹¤","pron":"ë¦¬ë“œ","weekly":true},
    {"en":"have","ko":"ê°€ì§€ë‹¤/í•˜ë‹¤","pron":"í•´ë¸Œ","weekly":true},
    {"en":"lesson","ko":"ìˆ˜ì—…","pron":"ë ˆìŠ¨","weekly":true},
    {"en":"together","ko":"í•¨ê»˜","pron":"íˆ¬ê²Œë”","weekly":true},

    {"en":"pizza","ko":"í”¼ì","pron":"í”¼ì","weekly":true},
    {"en":"sit","ko":"ì•‰ë‹¤","pron":"ì‹¯","weekly":true},
    {"en":"good","ko":"ì¢‹ì€","pron":"êµ¿","weekly":true},
    {"en":"class","ko":"ë°˜/ìˆ˜ì—…","pron":"í´ë˜ìŠ¤","weekly":true},
    {"en":"hair","ko":"ë¨¸ë¦¬ì¹´ë½","pron":"í—¤ì–´","weekly":true},
    {"en":"write","ko":"ì“°ë‹¤","pron":"ë¼ì´íŠ¸","weekly":true},

    {"en":"time","ko":"ì‹œê°„","pron":"íƒ€ì„","weekly":true},
    {"en":"soccer","ko":"ì¶•êµ¬","pron":"ì‚¬ì»¤","weekly":true},
    {"en":"can","ko":"í•  ìˆ˜ ìˆë‹¤","pron":"ìº”","weekly":true},
    {"en":"look","ko":"ë³´ë‹¤","pron":"ë£©","weekly":true},
    {"en":"please","ko":"ì œë°œ/ë¶€íƒí•´ìš”","pron":"í”Œë¦¬ì¦ˆ","weekly":true},
    {"en":"world","ko":"ì„¸ê³„","pron":"ì›”ë“œ","weekly":true},

    {"en":"hat","ko":"ëª¨ì","pron":"í–‡","weekly":true},
    {"en":"up","ko":"ìœ„ë¡œ/ì˜¬ë¼ê°€","pron":"ì—…","weekly":true},
    {"en":"old","ko":"ëŠ™ì€/ì˜¤ë˜ëœ","pron":"ì˜¬ë“œ","weekly":true},
    {"en":"great","ko":"ë©‹ì§„/í›Œë¥­í•œ","pron":"ê·¸ë ˆì´íŠ¸","weekly":true},
    {"en":"song","ko":"ë…¸ë˜","pron":"ì†¡","weekly":true},
    {"en":"listen","ko":"ë“£ë‹¤","pron":"ë¦¬ìŠ¨","weekly":true},

    {"en":"day","ko":"ë‚ /í•˜ë£¨","pron":"ë°ì´","weekly":true},
    {"en":"want","ko":"ì›í•˜ë‹¤","pron":"ì›íŠ¸","weekly":true},
    {"en":"and","ko":"ê·¸ë¦¬ê³ ","pron":"ì•¤ë“œ","weekly":true},
    {"en":"study","ko":"ê³µë¶€í•˜ë‹¤","pron":"ìŠ¤í„°ë””","weekly":true},
    {"en":"summer","ko":"ì—¬ë¦„","pron":"ì„œë¨¸","weekly":true},
    {"en":"picture","ko":"ì‚¬ì§„/ê·¸ë¦¼","pron":"í”½ì²˜","weekly":true},

    {"en":"bag","ko":"ê°€ë°©","pron":"ë°±","weekly":true},
    {"en":"dog","ko":"ê°œ","pron":"ë…","weekly":true},
    {"en":"who","ko":"ëˆ„êµ¬","pron":"í›„","weekly":true},
    {"en":"week","ko":"ì£¼/ì¼ì£¼ì¼","pron":"ìœ„í¬","weekly":true},
    {"en":"today","ko":"ì˜¤ëŠ˜","pron":"íˆ¬ë°ì´","weekly":true},
    {"en":"story","ko":"ì´ì•¼ê¸°","pron":"ìŠ¤í† ë¦¬","weekly":true},

    {"en":"talk","ko":"ë§í•˜ë‹¤","pron":"í†¡","weekly":true},
    {"en":"do","ko":"í•˜ë‹¤","pron":"ë‘","weekly":true},
    {"en":"check","ko":"í™•ì¸í•˜ë‹¤","pron":"ì²´í¬","weekly":true},
    {"en":"happy","ko":"í–‰ë³µí•œ","pron":"í•´í”¼","weekly":true},
    {"en":"tiger","ko":"í˜¸ë‘ì´","pron":"íƒ€ì´ê±°","weekly":true},
    {"en":"homework","ko":"ìˆ™ì œ","pron":"í™ˆì›Œí¬","weekly":true},

    {"en":"cap","ko":"ëª¨ì(ìº¡)","pron":"ìº¡","weekly":true},
    {"en":"jump","ko":"ì í”„í•˜ë‹¤","pron":"ì í”„","weekly":true},
    {"en":"watch","ko":"ë³´ë‹¤/ì‹œê³„","pron":"ì›Œì¹˜","weekly":true},
    {"en":"friend","ko":"ì¹œêµ¬","pron":"í”„ë Œë“œ","weekly":true},
    {"en":"music","ko":"ìŒì•…","pron":"ë®¤ì§","weekly":true},
    {"en":"in","ko":"~ì•ˆì—","pron":"ì¸","weekly":true},

    {"en":"room","ko":"ë°©","pron":"ë£¸","weekly":true},
    {"en":"take","ko":"ê°€ì§€ë‹¤/íƒ€ë‹¤","pron":"í…Œì´í¬","weekly":true},
    {"en":"turn","ko":"ëŒë‹¤/ì°¨ë¡€","pron":"í„´","weekly":true},
    {"en":"put","ko":"ë†“ë‹¤","pron":"í’‹","weekly":true},
    {"en":"science","ko":"ê³¼í•™","pron":"ì‚¬ì´ì–¸ìŠ¤","weekly":true},
    {"en":"breakfast","ko":"ì•„ì¹¨ ì‹ì‚¬","pron":"ë¸Œë ‰í¼ìŠ¤íŠ¸","weekly":true},

    {"en":"big","ko":"í°","pron":"ë¹…","weekly":true},
    {"en":"box","ko":"ìƒì","pron":"ë°•ìŠ¤","weekly":true},
    {"en":"about","ko":"~ì— ëŒ€í•´/ëŒ€ëµ","pron":"ì–´ë°”ì›ƒ","weekly":true},
    {"en":"movie","ko":"ì˜í™”","pron":"ë¬´ë¹„","weekly":true},
    {"en":"word","ko":"ë‹¨ì–´","pron":"ì›Œë“œ","weekly":true},
    {"en":"say","ko":"ë§í•˜ë‹¤","pron":"ì„¸ì´","weekly":true},

    {"en":"birthday","ko":"ìƒì¼","pron":"ë²ŒìŠ¤ë°ì´","weekly":true},
    {"en":"will","ko":"~í•  ê²ƒì´ë‹¤","pron":"ìœŒ","weekly":true},
    {"en":"sing","ko":"ë…¸ë˜í•˜ë‹¤","pron":"ì‹±","weekly":true},
    {"en":"bike","ko":"ìì „ê±°","pron":"ë°”ì´í¬","weekly":true},
    {"en":"library","ko":"ë„ì„œê´€","pron":"ë¼ì´ë¸ŒëŸ¬ë¦¬","weekly":true},
    {"en":"festival","ko":"ì¶•ì œ","pron":"í˜ìŠ¤í‹°ë²Œ","weekly":true},

    {"en":"sad","ko":"ìŠ¬í”ˆ","pron":"ìƒˆë“œ","weekly":true},
    {"en":"run","ko":"ë‹¬ë¦¬ë‹¤","pron":"ëŸ°","weekly":true},
    {"en":"ball","ko":"ê³µ","pron":"ë³¼","weekly":true},
    {"en":"on","ko":"~ìœ„ì—","pron":"ì˜¨","weekly":true},
    {"en":"many","ko":"ë§ì€","pron":"ë§¤ë‹ˆ","weekly":true},
    {"en":"color","ko":"ìƒ‰/ìƒ‰ê¹”","pron":"ì»¬ëŸ¬","weekly":true},

    {"en":"come","ko":"ì˜¤ë‹¤","pron":"ì»´","weekly":true},
    {"en":"angry","ko":"í™”ë‚œ","pron":"ì•µê·¸ë¦¬","weekly":true},
    {"en":"speak","ko":"ë§í•˜ë‹¤","pron":"ìŠ¤í”¼í¬","weekly":true},
    {"en":"water","ko":"ë¬¼","pron":"ì›Œí„°","weekly":true},
    {"en":"morning","ko":"ì•„ì¹¨","pron":"ëª¨ë‹","weekly":true},
    {"en":"afternoon","ko":"ì˜¤í›„","pron":"ì• í”„í„°ëˆˆ","weekly":true},

    {"en":"milk","ko":"ìš°ìœ ","pron":"ë°€í¬","weekly":true},
    {"en":"tea","ko":"ì°¨(í‹°)","pron":"í‹°","weekly":true},
    {"en":"japan","ko":"ì¼ë³¸","pron":"ì¬íŒ¬","weekly":true},
    {"en":"china","ko":"ì¤‘êµ­","pron":"ì°¨ì´ë‚˜","weekly":true},
    {"en":"or","ko":"ë˜ëŠ”","pron":"ì˜¤ì–´","weekly":true},
    {"en":"from","ko":"~ì—ì„œ(ë¶€í„°)","pron":"í”„ë¡¬","weekly":true},

    {"en":"pen","ko":"íœ","pron":"íœ","weekly":true},
    {"en":"desk","ko":"ì±…ìƒ","pron":"ë°ìŠ¤í¬","weekly":true},
    {"en":"toy","ko":"ì¥ë‚œê°","pron":"í† ì´","weekly":true},
    {"en":"see","ko":"ë³´ë‹¤","pron":"ì”¨","weekly":true},
    {"en":"for","ko":"~ì„/ë¥¼ ìœ„í•´","pron":"í¬","weekly":true},
    {"en":"smell","ko":"ëƒ„ìƒˆ/ëƒ„ìƒˆ ë§¡ë‹¤","pron":"ìŠ¤ë©œ","weekly":true},
    {"en":"under","ko":"~ì•„ë˜ì—","pron":"ì–¸ë”","weekly":true},
    {"en":"swim","ko":"ìˆ˜ì˜í•˜ë‹¤","pron":"ìŠ¤ìœ”","weekly":true},
    {"en":"make","ko":"ë§Œë“¤ë‹¤","pron":"ë©”ì´í¬","weekly":true},
    {"en":"ready","ko":"ì¤€ë¹„ëœ","pron":"ë ˆë””","weekly":true},
    {"en":"weekend","ko":"ì£¼ë§","pron":"ìœ„ì¼„ë“œ","weekly":true},
    {"en":"tomorrow","ko":"ë‚´ì¼","pron":"íˆ¬ëª¨ë¡œìš°","weekly":true},
    {"en":"nice","ko":"ì¢‹ì€/ì¹œì ˆí•œ","pron":"ë‚˜ì´ìŠ¤","weekly":true},
    {"en":"excellent","ko":"ì•„ì£¼ í›Œë¥­í•œ","pron":"ì—‘ì„¤ëŸ°íŠ¸","weekly":true}
  ];

  /** @type {{id:string,en:string,ko:string,pron:string,weekly?:boolean, spell?:any}[]} */
  let words = loadWords();
  let meta = loadMeta();
  let quiz = null;

  // elements
  const countPill = document.getElementById("countPill");
  const modeSel = document.getElementById("mode");
  const startBtn = document.getElementById("startBtn");

  const w_en = document.getElementById("w_en");
  const w_ko = document.getElementById("w_ko");
  const w_pron = document.getElementById("w_pron");
  const w_week = document.getElementById("w_week");
  const addBtn = document.getElementById("addBtn");

  const bulk = document.getElementById("bulk");
  const bulkAddBtn = document.getElementById("bulkAddBtn");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const resetBtn = document.getElementById("resetBtn");
  const clearWeeklyBtn = document.getElementById("clearWeeklyBtn");
  const markAllWeeklyBtn = document.getElementById("markAllWeeklyBtn");

  const gameCard = document.getElementById("gameCard");
  const stageLabel = document.getElementById("stageLabel");
  const promptEl = document.getElementById("prompt");
  const hintEl = document.getElementById("hint");
  const optionsEl = document.getElementById("options");

  const chunkArea = document.getElementById("chunkArea");
  const chunkSlots = document.getElementById("chunkSlots");
  const builtWordPill = document.getElementById("builtWordPill");
  const resetChunksBtn = document.getElementById("resetChunksBtn");
  const checkChunksBtn = document.getElementById("checkChunksBtn");
  const chunkFeedback = document.getElementById("chunkFeedback");

  const feedback = document.getElementById("feedback");
  const nextBtn = document.getElementById("nextBtn");
  const skipBtn = document.getElementById("skipBtn");
  const scorePill = document.getElementById("scorePill");
  const idxPill = document.getElementById("idxPill");
  const streakPill = document.getElementById("streakPill");
  const bar = document.getElementById("bar");

  const scopeSel = document.getElementById("scope");
  const reviewBtn = document.getElementById("reviewBtn");

  const speakBtn = document.getElementById("speakBtn");
  const autoSpeak = document.getElementById("autoSpeak");
  const ttsNote = document.getElementById("ttsNote");
  const toggleGameOnly = document.getElementById("toggleGameOnly");

  const starsPill = document.getElementById("starsPill");
  const stickersPill = document.getElementById("stickersPill");
  const rewardBtn = document.getElementById("rewardBtn");
  const rewardHint = document.getElementById("rewardHint");

  const tbody = document.getElementById("tbody");

  // storage
  function loadWords() {
    try {
      const raw = localStorage.getItem(LS_WORDS);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr
        .filter(x => x && typeof x.en === "string")
        .map(x => ({
          id: x.id || crypto.randomUUID(),
          en: (x.en||"").trim(),
          ko: (x.ko||"").trim(),
          pron: (x.pron||"").trim(),
          weekly: !!x.weekly,
          spell: x.spell || null
        }))
        .filter(x => x.en.length > 0);
    } catch { return []; }
  }

  function saveWords() {
    localStorage.setItem(LS_WORDS, JSON.stringify(words));
    renderCount(); renderList();
  }

  function loadMeta() {
    try {
      const raw = localStorage.getItem(LS_META);
      if (!raw) return { stars: 0, stickers: 0, streak: 0, wrongIds: [] };
      const x = JSON.parse(raw);
      return {
        stars: Number.isFinite(x.stars) ? x.stars : 0,
        stickers: Number.isFinite(x.stickers) ? x.stickers : 0,
        streak: Number.isFinite(x.streak) ? x.streak : 0,
        wrongIds: Array.isArray(x.wrongIds) ? x.wrongIds : []
      };
    } catch { return { stars: 0, stickers: 0, streak: 0, wrongIds: [] }; }
  }

  function saveMeta() {
    localStorage.setItem(LS_META, JSON.stringify(meta));
    renderReward();
  }

  function loadTts() {
    try {
      const raw = localStorage.getItem(LS_TTS);
      if (!raw) return { autoSpeak: true };
      const x = JSON.parse(raw);
      return { autoSpeak: !!x.autoSpeak };
    } catch { return { autoSpeak: true }; }
  }

  function saveTts() {
    localStorage.setItem(LS_TTS, JSON.stringify({ autoSpeak: autoSpeak.checked }));
  }

  function renderCount() { countPill.textContent = `ë‹¨ì–´ ${words.length}ê°œ`; }

  function escapeHtml(s) {
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function renderList() {
    tbody.innerHTML = "";
    for (const w of words) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="chk" data-week="${w.id}" ${w.weekly ? "checked":""} /></td>
        <td><input data-k="en" data-id="${w.id}" value="${escapeHtml(w.en)}" /></td>
        <td><input data-k="ko" data-id="${w.id}" value="${escapeHtml(w.ko)}" /></td>
        <td><input data-k="pron" data-id="${w.id}" value="${escapeHtml(w.pron)}" /></td>
        <td class="right"><button class="danger" data-del="${w.id}">ì‚­ì œ</button></td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("input[data-week]").forEach(chk => {
      chk.addEventListener("change", (e) => {
        const id = e.target.getAttribute("data-week");
        const idx = words.findIndex(x => x.id === id);
        if (idx >= 0) { words[idx].weekly = e.target.checked; saveWords(); }
      });
    });

    tbody.querySelectorAll("input[data-id]").forEach(inp => {
      inp.addEventListener("change", (e) => {
        const id = e.target.getAttribute("data-id");
        const k = e.target.getAttribute("data-k");
        const val = e.target.value.trim();
        const idx = words.findIndex(x => x.id === id);
        if (idx >= 0) { words[idx][k] = val; saveWords(); }
      });
    });

    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        words = words.filter(x => x.id !== id);
        meta.wrongIds = meta.wrongIds.filter(x => x !== id);
        saveWords(); saveMeta();
      });
    });
  }

  function addWord(en, ko, pron, weekly) {
    en = (en || "").trim();
    ko = (ko || "").trim();
    pron = (pron || "").trim();
    if (!en) return;

    const exists = words.find(w => w.en.toLowerCase() === en.toLowerCase());
    if (exists) {
      exists.ko = ko || exists.ko;
      exists.pron = pron || exists.pron;
      if (weekly !== undefined) exists.weekly = !!weekly;
    } else {
      words.unshift({ id: crypto.randomUUID(), en, ko, pron, weekly: !!weekly, spell: null });
    }
    saveWords();
  }

  function seedDefaultWordsIfEmpty() {
    if (Array.isArray(words) && words.length > 0) return;
    for (const x of DEFAULT_WORDS) {
      addWord(x.en, x.ko || "", x.pron || "", x.weekly ?? true);
    }
  }

  addBtn.addEventListener("click", () => {
    addWord(w_en.value, w_ko.value, w_pron.value, w_week.checked);
    w_en.value = ""; w_ko.value = ""; w_pron.value = ""; w_week.checked = false;
    w_en.focus();
  });

  bulkAddBtn.addEventListener("click", () => {
    const lines = bulk.value.split("\n").map(x => x.trim()).filter(Boolean);
    for (const line of lines) {
      const parts = (line.includes("|") ? line.split("|") : (line.includes(",") ? line.split(",") : [line]))
        .map(x => (x||"").trim());
      if (parts.length === 1) {
        addWord(parts[0], "", "", true);
      } else {
        const en = parts[0] || "";
        const ko = parts[1] || "";
        const pron = parts[2] || "";
        const weekly = (parts[3] || "").toLowerCase() === "week";
        addWord(en, ko, pron, weekly);
      }
    }
    bulk.value = "";
  });

  exportBtn.addEventListener("click", async () => {
    const data = JSON.stringify(words, null, 2);
    await navigator.clipboard.writeText(data).catch(()=>{});
    alert("í´ë¦½ë³´ë“œì— JSONìœ¼ë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.");
  });

  importBtn.addEventListener("click", () => {
    const txt = prompt("ë¶™ì—¬ë„£ì„ JSONì„ ì…ë ¥í•˜ì„¸ìš” (ê¸°ì¡´ ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤).");
    if (!txt) return;
    try {
      const arr = JSON.parse(txt);
      if (!Array.isArray(arr)) throw new Error();
      for (const x of arr) addWord(x.en, x.ko, x.pron, x.weekly);
      alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ");
    } catch {
      alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  });

  resetBtn.addEventListener("click", () => {
    if (!confirm("ì •ë§ ì „ì²´ ì‚­ì œí• ê¹Œìš”? (ë³´ìƒ/ë³µìŠµ ê¸°ë¡ë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)")) return;
    words = [];
    meta = { stars: 0, stickers: 0, streak: 0, wrongIds: [] };
    localStorage.removeItem(LS_WORDS);
    localStorage.removeItem(LS_META);
    saveWords(); saveMeta();
  });

  clearWeeklyBtn.addEventListener("click", () => {
    words.forEach(w => w.weekly = false);
    saveWords();
  });

  markAllWeeklyBtn.addEventListener("click", () => {
    words.forEach(w => w.weekly = true);
    saveWords();
  });

  function renderReward() {
    starsPill.textContent = `â­ ${meta.stars}`;
    stickersPill.textContent = `ğŸ… ${meta.stickers}`;
    const need = 10;
    const can = Math.floor(meta.stars / need);
    rewardBtn.disabled = can <= 0;
    rewardHint.textContent = can > 0 ? `ì§€ê¸ˆ ë³´ìƒ ${can}ê°œ ê°€ëŠ¥! (â­${need}=ğŸ…1)` : `â­${need}ê°œ ëª¨ìœ¼ë©´ ğŸ…1ê°œ`;
    streakPill.textContent = `ì—°ì† ${meta.streak}`;
  }

  rewardBtn.addEventListener("click", () => {
    const need = 10;
    const can = Math.floor(meta.stars / need);
    if (can <= 0) return;
    meta.stars -= need;
    meta.stickers += 1;
    saveMeta();
    alert("ë³´ìƒ íšë“! ğŸ… +1");
  });

  let bestEnVoice = null;
  function pickEnglishVoice() {
    const voices = speechSynthesis.getVoices();
    bestEnVoice =
      voices.find(v => /^en(-|_)/i.test(v.lang)) ||
      voices.find(v => /English/i.test(v.name)) ||
      null;
  }
  function updateTtsNote() {
    const hasApi = "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
    if (!hasApi) {
      ttsNote.textContent = "ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±(TTS)ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      speakBtn.disabled = true;
      return;
    }
    ttsNote.textContent = "ì²˜ìŒ í•œ ë²ˆ ğŸ”Š ë²„íŠ¼ì„ ëˆŒëŸ¬ë‘ë©´(íŠ¹íˆ iPhone), ì´í›„ ìë™ ì½ê¸°ê°€ ë” ì˜ ë©ë‹ˆë‹¤.";
  }
  function speak(text) {
    if (!("speechSynthesis" in window)) return;
    try { speechSynthesis.cancel(); } catch {}
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    if (bestEnVoice) u.voice = bestEnVoice;
    u.rate = 0.9;
    speechSynthesis.speak(u);
  }
  if ("speechSynthesis" in window) {
    pickEnglishVoice();
    speechSynthesis.onvoiceschanged = () => pickEnglishVoice();
  }

  speakBtn.addEventListener("click", () => {
    if (!quiz) return;
    const w = quiz.order[quiz.i];
    speak(w.en);
  });
  autoSpeak.addEventListener("change", saveTts);

  toggleGameOnly.addEventListener("click", () => {
    document.body.classList.toggle("gameOnly");
    toggleGameOnly.textContent = document.body.classList.contains("gameOnly") ? "â†©ï¸ ëŒì•„ê°€ê¸°" : "ğŸ“± ê²Œì„í™”ë©´ë§Œ";
  });

  function weeklyWords() { return words.filter(w => w.weekly); }
  function currentPool() { return scopeSel.value === "weekly" ? weeklyWords() : words; }

  function dedupeCase(arr) {
    const out = [];
    for (const x of arr) {
      if (!out.map(o=>String(o).toLowerCase()).includes(String(x).toLowerCase())) out.push(x);
    }
    return out;
  }

  const CONF = {
    "sch": ["sch","sk","ck"],
    "sh": ["sh","s","ch"],
    "ch": ["ch","sh","tch"],
    "ck": ["ck","k","c"],
    "ph": ["ph","f","p"],
    "th": ["th","t","s"],
    "wh": ["wh","w","h"],
    "oo": ["oo","u","ou"],
    "ee": ["ee","i","ea"],
    "ea": ["ea","e","ee"],
    "ai": ["ai","a","ay"],
    "ay": ["ay","ai","a"],
    "oa": ["oa","o","ow"],
    "ow": ["ow","o","oa"],
    "ou": ["ou","u","oo"],
    "ar": ["ar","er","or"],
    "er": ["er","ar","or"],
    "or": ["or","er","ar"],
    "ur": ["ur","er","or"],
    "tion": ["tion","shun","cion"],
    "ing": ["ing","in","ng"]
  };

  function chunkWord(en) {
    const low = en.toLowerCase();
    const chunks = [];
    let i = 0;
    const keys = Object.keys(CONF).sort((a,b)=>b.length-a.length);

    while (i < low.length) {
      let matched = null;
      for (const k of keys) {
        if (low.startsWith(k, i)) { matched = k; break; }
      }
      if (matched) {
        const corr = en.slice(i, i + matched.length);
        const options = dedupeCase([corr, ...CONF[matched]]).slice(0,3);
        chunks.push({ correct: corr, options });
        i += matched.length;
      } else {
        const corr = en[i];
        const cLow = low[i];
        let opts = [corr];

        if (cLow === "c") opts = [corr, "k", "ck"];
        else if (cLow === "k") opts = [corr, "c", "ck"];
        else if (cLow === "s") opts = [corr, "sh", "ch"];
        else if (cLow === "f") opts = [corr, "ph", "p"];
        else if (cLow === "l") opts = [corr, "r", "ll"];
        else if (cLow === "r") opts = [corr, "l", "rr"];
        else if (cLow === "g") opts = [corr, "j", "k"];
        else if (cLow === "j") opts = [corr, "g", "d"];
        else if (cLow === "a") opts = [corr, "e", "o"];
        else if (cLow === "e") opts = [corr, "i", "a"];
        else if (cLow === "i") opts = [corr, "ee", "e"];
        else if (cLow === "o") opts = [corr, "oa", "ow"];
        else if (cLow === "u") opts = [corr, "oo", "ou"];
        else opts = [corr, corr];

        chunks.push({ correct: corr, options: dedupeCase(opts).slice(0,3) });
        i += 1;
      }
    }
    return chunks;
  }

  let chunkState = null;

  function startChunkPuzzle(word) {
    const spell = (word.spell && Array.isArray(word.spell) && word.spell.length)
      ? word.spell
      : chunkWord(word.en);

    chunkState = { spell, picks: new Array(spell.length).fill(null) };
    chunkFeedback.textContent = "";
    renderChunkSlots();
    updateBuiltWord();
  }

  function renderChunkSlots() {
    chunkSlots.innerHTML = "";
    chunkState.spell.forEach((part, idx) => {
      const slot = document.createElement("div");
      slot.className = "chunkCard";
      slot.innerHTML = `
        <div class="muted" style="margin-bottom:8px;">${idx+1}ë²ˆì§¸ ì¡°ê°</div>
        <div class="row" style="gap:10px;"></div>
      `;
      const row = slot.querySelector(".row");
      const opts = shuffle(part.options);

      opts.forEach(opt => {
        const b = document.createElement("button");
        b.className = "secondary";
        b.textContent = opt;
        b.style.padding = "14px 12px";
        b.style.fontSize = "18px";
        b.addEventListener("click", () => {
          chunkState.picks[idx] = opt;
          renderChunkSlots();
          updateBuiltWord();
        });
        if (chunkState.picks[idx] && String(chunkState.picks[idx]).toLowerCase() === String(opt).toLowerCase()) {
          b.className = "";
          b.style.background = "#ecfdf3";
          b.style.borderColor = "#16a34a";
        }
        row.appendChild(b);
      });

      chunkSlots.appendChild(slot);
    });
  }

  function updateBuiltWord() {
    const built = chunkState.picks.map(x => x || "â–¡").join("");
    builtWordPill.textContent = `ì™„ì„±: ${built}`;
  }

  resetChunksBtn.addEventListener("click", () => {
    if (!chunkState) return;
    chunkState.picks.fill(null);
    chunkFeedback.textContent = "";
    renderChunkSlots();
    updateBuiltWord();
  });

  checkChunksBtn.addEventListener("click", () => {
    if (!quiz || !chunkState) return;
    const w = quiz.order[quiz.i];

    if (chunkState.picks.some(x => !x)) {
      chunkFeedback.textContent = "ì•„ì§ ë¹ˆ ì¹¸ì´ ìˆì–´ìš”! â–¡ë¥¼ ì±„ì›Œì£¼ì„¸ìš”.";
      return;
    }

    const ok = chunkState.spell.every((part, i) =>
      String(chunkState.picks[i]).toLowerCase() === String(part.correct).toLowerCase()
    );

    if (ok) {
      chunkFeedback.textContent = "ì •ë‹µ! âœ… (+1ì , +â­1)";
      quiz.score += 1;
      meta.stars += 1;
      meta.streak += 1;
      if (meta.streak > 0 && meta.streak % 5 === 0) meta.stars += 2;
      saveMeta();
      scorePill.textContent = `ì ìˆ˜ ${quiz.score}`;
      if (autoSpeak.checked) speak(w.en);
      nextBtn.style.display = "inline-block";
    } else {
      chunkFeedback.textContent = `ì˜¤ë‹µ! ğŸ˜… ì •ë‹µì€ "${w.en}" ì…ë‹ˆë‹¤.`;
      meta.streak = 0;
      if (!meta.wrongIds.includes(w.id)) meta.wrongIds.push(w.id);
      saveMeta();
    }
  });

  function startQuiz(mode, {review=false}={}) {
    const pool = review ? getReviewPool() : currentPool();
    if (words.length < 4) { alert("ì „ì²´ ë‹¨ì–´ê°€ ìµœì†Œ 4ê°œ í•„ìš”í•©ë‹ˆë‹¤."); return; }
    if (!review && pool.length < 4 && scopeSel.value === "weekly") {
      alert("ì´ë²ˆ ì£¼ ë‹¨ì–´ê°€ 4ê°œ ë¯¸ë§Œì…ë‹ˆë‹¤. (ìµœì†Œ 4ê°œ í•„ìš”)\nì´ë²ˆ ì£¼ ì²´í¬ë¥¼ ë” í•˜ì‹œê±°ë‚˜, ì¶œì œë¥¼ 'ëˆ„ì (ì „ì²´)'ë¡œ ë°”ê¿”ì£¼ì„¸ìš”.");
      return;
    }
    if (review && pool.length === 0) { alert("ìµœê·¼ ê²Œì„ì—ì„œ í‹€ë¦° ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‘"); return; }

    const order = shuffle([...pool]).slice(0, Math.min(pool.length, 20));
    quiz = { mode, order, i: 0, score: 0, isReview: review };

    if (!review) {
      meta.wrongIds = [];
      saveMeta();
    }

    gameCard.style.display = "block";
    nextBtn.style.display = "none";
    feedback.textContent = "";
    renderQuestion();
  }

  function renderQuestion() {
    if (!quiz) return;
    feedback.textContent = "";
    nextBtn.style.display = "none";
    optionsEl.innerHTML = "";
    chunkArea.style.display = "none";

    const total = quiz.order.length;
    const idx = quiz.i + 1;
    idxPill.textContent = `${idx} / ${total}`;
    scorePill.textContent = `ì ìˆ˜ ${quiz.score}`;
    bar.style.width = `${Math.round((quiz.i / total) * 100)}%`;

    const w = quiz.order[quiz.i];
    const pool = makeChoices(w, 4);

    if (quiz.mode === "meaning") {
      stageLabel.textContent = quiz.isReview ? "ë³µìŠµ: ëœ»" : "1ë‹¨ê³„: ëœ»";
      promptEl.textContent = w.en;
      hintEl.textContent = "ëœ»ì„ ê³ ë¥´ì„¸ìš”.";
      pool.map(x => x.ko || "(ëœ» ì—†ìŒ)").forEach((label, n) => addOptionButton(label, pool[n].id === w.id, w));
      return;
    }

    if (quiz.mode === "pron") {
      stageLabel.textContent = quiz.isReview ? "ë³µìŠµ: ë°œìŒ(í•œê¸€)" : "2ë‹¨ê³„: ë°œìŒ(í•œê¸€)";
      promptEl.textContent = w.en;
      hintEl.textContent = "ë°œìŒ(í•œê¸€)ì„ ê³ ë¥´ì„¸ìš”.";
      pool.map(x => x.pron || "(ë°œìŒ ì—†ìŒ)").forEach((label, n) => addOptionButton(label, pool[n].id === w.id, w));
      return;
    }

    if (quiz.mode === "spelling") {
      stageLabel.textContent = quiz.isReview ? "ë³µìŠµ: ìŠ¤í ë§(ì¡°ê°)" : "3ë‹¨ê³„: ìŠ¤í ë§(ì¡°ê°)";
      promptEl.textContent = w.ko || "(ëœ» ì—†ìŒ)";
      hintEl.textContent = "ì¡°ê°ì„ ìˆœì„œëŒ€ë¡œ ê³¨ë¼ ë‹¨ì–´ë¥¼ ì™„ì„±í•˜ì„¸ìš”.";
      chunkArea.style.display = "block";
      startChunkPuzzle(w);
      return;
    }
  }

  function addOptionButton(label, isCorrect, w) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.addEventListener("click", () => onPick(btn, isCorrect, w));
    optionsEl.appendChild(btn);
  }

  function onPick(btn, isCorrect, w) {
    [...optionsEl.children].forEach(b => b.disabled = true);

    if (isCorrect) {
      btn.classList.add("correct");
      quiz.score += 1;
      meta.streak += 1;
      meta.stars += 1;
      if (meta.streak > 0 && meta.streak % 5 === 0) meta.stars += 2;
      feedback.textContent = (meta.streak % 5 === 0) ? `ì •ë‹µ! ğŸ‘ ì—°ì† ${meta.streak} (ë³´ë„ˆìŠ¤â­+2!)` : "ì •ë‹µ! ğŸ‘";
      if (autoSpeak.checked) speak(w.en);
    } else {
      btn.classList.add("wrong");
      feedback.textContent = `ì˜¤ë‹µ! ì •ë‹µ: ${w.en}`;
      meta.streak = 0;
      if (!meta.wrongIds.includes(w.id)) meta.wrongIds.push(w.id);
    }

    saveMeta();
    nextBtn.style.display = "inline-block";
  }

  nextBtn.addEventListener("click", () => {
    if (!quiz) return;
    quiz.i += 1;
    if (quiz.i >= quiz.order.length) {
      bar.style.width = `100%`;
      alert(`ë! ì ìˆ˜: ${quiz.score}\ní‹€ë¦° ë‹¨ì–´: ${meta.wrongIds.length}ê°œ (ë³µìŠµ ë²„íŠ¼ìœ¼ë¡œ ê°€ëŠ¥)`);
      quiz = null;
      gameCard.style.display = "none";
      return;
    }
    renderQuestion();
  });

  skipBtn.addEventListener("click", () => {
    if (!quiz) return;
    meta.streak = 0;
    saveMeta();
    quiz.i += 1;
    if (quiz.i >= quiz.order.length) {
      bar.style.width = `100%`;
      alert("ë!");
      quiz = null;
      gameCard.style.display = "none";
      return;
    }
    renderQuestion();
  });

  function getReviewPool() {
    const wrongSet = new Set(meta.wrongIds);
    return words.filter(w => wrongSet.has(w.id));
  }

  reviewBtn.addEventListener("click", () => startQuiz(modeSel.value, {review:true}));
  startBtn.addEventListener("click", () => startQuiz(modeSel.value));

  scopeSel.addEventListener("change", () => {
    if (scopeSel.value === "weekly" && weeklyWords().length < 4) {
      alert("ì´ë²ˆ ì£¼ ë‹¨ì–´ê°€ 4ê°œ ë¯¸ë§Œì…ë‹ˆë‹¤. (ìµœì†Œ 4ê°œ í•„ìš”)\nì´ë²ˆ ì£¼ ì²´í¬ë¥¼ ë” í•˜ì‹œê±°ë‚˜, ëˆ„ì ìœ¼ë¡œ ë°”ê¿”ì£¼ì„¸ìš”.");
    }
  });

  function makeChoices(correct, n) {
    const basePool = currentPool();
    const others = basePool.filter(w => w.id !== correct.id);
    const fallback = words.filter(w => w.id !== correct.id);
    const src = (others.length >= n-1) ? others : fallback;
    const picks = shuffle(src).slice(0, Math.max(0, n - 1));
    return shuffle([correct, ...picks]);
  }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // âœ… ì‹œì‘ ì‹œ: ë‹¨ì–´ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ë‹¨ì–´ ìë™ ì£¼ì…
  seedDefaultWordsIfEmpty();

  // init
  renderCount();
  renderList();
  renderReward();
  const tts = loadTts();
  autoSpeak.checked = tts.autoSpeak;
  updateTtsNote();
})();
</script>
</body>
</html>
